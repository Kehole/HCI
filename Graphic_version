<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glanceable Cognitive Flow Test</title>
    <style>
        /* DESIGN RATIONALE:
           Background is dark to reduce eye strain and increase contrast for the data elements,
           similar to the "Mondaine" clock's high-contrast principle[cite: 101].
        */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }

        h1, p { margin-bottom: 20px; text-align: center; }
        
        /* TASK COUNTER */
        #task-tracker {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #333;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #555;
            font-size: 0.9rem;
        }

        /* --- THE GLANCEABLE GRID --- */
        #grid-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            background: #252525;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        /* PREATTENTIVE ATTRIBUTES IMPLEMENTATION */
        .server-node {
            width: 60px;
            height: 60px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .server-node:hover { transform: scale(1.1); background: #444; }

        .indicator {
            width: 6px;
            height: 35px;
            background-color: #4CAF50;
            border-radius: 3px;
            transition: all 0.5s ease;
        }

        /* STATE: LATENCY */
        .status-latency .indicator {
            background-color: #FFC107;
            transform: rotate(25deg);
        }

        /* STATE: CRITICAL */
        .status-critical .indicator {
            background-color: #FF5252;
            height: 35px;
            box-shadow: 0 0 10px #FF5252;
        }

        /* --- DETAIL VIEW (Drill Down) --- */
        #detail-view, #modal-overlay {
            display: none;
            flex-direction: column;
            width: 300px;
            background: #2c2c2c;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #444;
        }

        .chart-bar-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
            font-size: 0.8rem;
        }
        .bar {
            height: 10px;
            background: #555;
            margin-left: 10px;
            border-radius: 5px;
        }
        .bar.high { background: #FF5252; width: 180px; }
        .bar.low { background: #4CAF50; width: 40px; }

        button {
            margin-top: 15px;
            padding: 10px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        button:hover { background: #1976D2; }
        button.secondary { background: #555; margin-top: 10px; }

        /* MODAL */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background: #333;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid #FF5252;
        }

        /* ===== ADDITIONAL STYLES ===== */

        #instructions-screen {
            max-width: 560px;
            background: #252525;
            padding: 36px 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        #instructions-screen h1 { margin-bottom: 24px; }

        .legend-section { margin-bottom: 22px; }

        .legend-section h3 {
            font-size: 0.95rem;
            margin: 0 0 12px 0;
            color: #bbb;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .legend-row {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }

        .legend-indicator-box {
            width: 48px;
            height: 48px;
            background: #333;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .legend-line {
            width: 6px;
            height: 28px;
            border-radius: 3px;
        }

        .legend-line.green   { background-color: #4CAF50; }
        .legend-line.yellow  { background-color: #FFC107; }
        .legend-line.red     { background-color: #FF5252; box-shadow: 0 0 8px #FF5252; }
        .legend-line.tilted  { transform: rotate(25deg); }

        .legend-text { line-height: 1.4; }
        .legend-text strong { color: #fff; }

        .server-node.selected {
            outline: 3px solid #2196F3;
            outline-offset: 2px;
            background: #3a3a3a;
        }

        #feedback {
            min-height: 28px;
            margin-top: 12px;
            font-size: 0.95rem;
            text-align: center;
        }
        #feedback.wrong { color: #FF5252; }
        #feedback.correct { color: #4CAF50; }

        #complete-screen {
            display: none;
            text-align: center;
            max-width: 580px;
            background: #252525;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .status-busy .indicator { background-color: #FFC107; }

        .status-critical-latency .indicator {
            background-color: #FF5252;
            transform: rotate(25deg);
            box-shadow: 0 0 10px #FF5252;
        }

        .status-healthy-latency .indicator {
            background-color: #4CAF50;
            transform: rotate(25deg);
        }

        /* ===== COUNTDOWN TIMER BAR ===== */
        #timer-bar-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: #333;
            z-index: 200;
            display: none;
        }

        #timer-bar {
            height: 100%;
            width: 100%;
            background: #2196F3;
            border-radius: 0 3px 3px 0;
        }

        #timer-bar.warning { background: #FFC107; }
        #timer-bar.danger  { background: #FF5252; }

        #timer-label {
            position: fixed;
            top: 10px;
            left: 20px;
            font-size: 0.85rem;
            color: #999;
            z-index: 201;
            display: none;
        }

        /* ===== REPORT ===== */
        .report-summary {
            display: flex;
            justify-content: space-around;
            margin: 24px 0;
            padding: 16px;
            background: #333;
            border-radius: 8px;
        }

        .report-stat { text-align: center; }

        .report-stat-value {
            font-size: 1.6rem;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }

        .report-stat-label {
            font-size: 0.75rem;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.85rem;
        }

        .report-table th,
        .report-table td {
            padding: 10px 14px;
            text-align: left;
            border-bottom: 1px solid #444;
        }

        .report-table th {
            color: #999;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
        }

        .report-table td { color: #ddd; }
        .report-status-pass    { color: #4CAF50; font-weight: 600; }
        .report-status-fail    { color: #FF5252; font-weight: 600; }
        .report-status-timeout { color: #FFC107; font-weight: 600; }
    </style>
</head>
<body>

    <!-- COUNTDOWN TIMER BAR -->
    <div id="timer-bar-wrapper"><div id="timer-bar"></div></div>
    <div id="timer-label">15s</div>

    <!-- TASK TRACKER -->
    <div id="task-tracker" style="display:none;">Task: <span id="step-count">1</span> / 9</div>

    <!-- ===== SCREEN 1: INSTRUCTIONS ===== -->
    <div id="instructions-screen">
        <h1>Server Health Monitor</h1>
        <p>Before you begin, please review the rules below.</p>

        <div class="legend-section">
            <h3>Color — Server Status</h3>
            <div class="legend-row">
                <div class="legend-indicator-box"><div class="legend-line green"></div></div>
                <span class="legend-text"><strong>Green</strong> — Healthy (Memory Load: Normal)</span>
            </div>
            <div class="legend-row">
                <div class="legend-indicator-box"><div class="legend-line yellow"></div></div>
                <span class="legend-text"><strong>Yellow</strong> — Busy (Memory Load: Heavy)</span>
            </div>
            <div class="legend-row">
                <div class="legend-indicator-box"><div class="legend-line red"></div></div>
                <span class="legend-text"><strong>Red</strong> — Crashed (Memory Load: OFFLINE)</span>
            </div>
        </div>

        <div class="legend-section">
            <h3>Orientation — Latency</h3>
            <div class="legend-row">
                <div class="legend-indicator-box"><div class="legend-line green"></div></div>
                <span class="legend-text"><strong>Vertical ( | )</strong> — Systems acting normally</span>
            </div>
            <div class="legend-row">
                <div class="legend-indicator-box"><div class="legend-line green tilted"></div></div>
                <span class="legend-text"><strong>Tilted ( \ )</strong> — Systems experiencing latency</span>
            </div>
        </div>

        <p style="font-size:0.85rem; color:#999; margin-top:8px;">
            You will complete <strong style="color:#f0f0f0;">9 tasks</strong>. Each task asks you to find and click a specific server in the grid, then press <em>Confirm</em>. You have <strong style="color:#f0f0f0;">15 seconds</strong> per task. If your selection is wrong you will try again. If time runs out the task is skipped and marked as failed.
        </p>

        <button onclick="startTest()" style="width:100%; margin-top:20px;">I Understand — Start Test</button>
    </div>

    <!-- ===== SCREEN 2: TASK / DASHBOARD ===== -->
    <div id="dashboard-screen" style="display:none;">
        <h1>Server Health Monitor</h1>
        <p id="task-prompt"></p>
        <div id="grid-container"></div>
        <div id="feedback"></div>
        <button id="confirm-btn" onclick="confirmSelection()" style="margin-top:18px; width:260px; display:block; margin-left:auto; margin-right:auto;" disabled>Confirm Selection</button>
    </div>

    <!-- ===== SCREEN 3: REPORT ===== -->
    <div id="complete-screen">
        <h1>Test Report</h1>
        <p>Here are your results for this session.</p>

        <div class="report-summary">
            <div class="report-stat">
                <span class="report-stat-value" id="report-correct" style="color:#4CAF50;">0</span>
                <span class="report-stat-label">Passed</span>
            </div>
            <div class="report-stat">
                <span class="report-stat-value" id="report-wrong" style="color:#FF5252;">0</span>
                <span class="report-stat-label">Wrong Attempts</span>
            </div>
            <div class="report-stat">
                <span class="report-stat-value" id="report-timeout" style="color:#FFC107;">0</span>
                <span class="report-stat-label">Timed Out</span>
            </div>
            <div class="report-stat">
                <span class="report-stat-value" id="report-total-time" style="color:#2196F3;">0s</span>
                <span class="report-stat-label">Total Time</span>
            </div>
        </div>

        <table class="report-table">
            <thead>
                <tr>
                    <th>Task</th>
                    <th>Description</th>
                    <th>Time</th>
                    <th>Attempts</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody id="report-body"></tbody>
        </table>

        <button onclick="location.reload()" style="width:100%;">Restart Test</button>
    </div>

    <script>
        // ===== TASK DEFINITIONS (9 tasks — trick task is always #7) =====
        const TASKS = [
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Crashed</strong> server.",
                target: "critical",
                distractors: ["busy"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Busy</strong> server that suffers <strong>Latency</strong>.",
                target: "busy-latency",
                distractors: ["busy", "healthy-latency"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Crashed</strong> server that suffers <strong>Latency</strong>.",
                target: "critical-latency",
                distractors: ["critical", "busy-latency"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Busy</strong> server.",
                target: "busy",
                distractors: ["healthy-latency"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Healthy</strong> server that suffers <strong>Latency</strong>.",
                target: "healthy-latency",
                distractors: ["busy", "critical"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Crashed</strong> server.",
                target: "critical",
                distractors: ["busy-latency", "healthy-latency"]
            },
            // --- TASK 7: TRICK — all servers are Healthy, no Busy exists, any click accepted ---
            {
                prompt: "Task: Glance at the grid. Find and click the server that runs <strong>Normal</strong>.",
                target: "any",
                distractors: []
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Busy</strong> server that suffers <strong>Latency</strong>.",
                target: "busy-latency",
                distractors: ["critical", "busy"]
            },
            {
                prompt: "Task: Glance at the grid. Find and click the <strong>Crashed</strong> server that suffers <strong>Latency</strong>.",
                target: "critical-latency",
                distractors: ["busy-latency", "healthy-latency", "busy"]
            }
        ];

        const TASK_LABELS = [
            "Find Crashed server",
            "Find Busy + Latency server",
            "Find Crashed + Latency server",
            "Find Busy server",
            "Find Healthy + Latency server",
            "Find Crashed server (v2)",
            "Find Normal server (trick)",
            "Find Busy + Latency server (v2)",
            "Find Crashed + Latency server (v2)"
        ];

        // ===== STATE =====
        let currentTask = 0;
        let selectedIndex = -1;
        let targetIndex = -1;
        let taskLocked = false;

        const TIMER_DURATION = 15;
        let timerInterval = null;
        let timerStart = 0;

        let results = [];
        let currentAttempts = 0;

        // DOM refs
        const instructionsScreen = document.getElementById('instructions-screen');
        const dashboardScreen    = document.getElementById('dashboard-screen');
        const completeScreen     = document.getElementById('complete-screen');
        const taskTracker        = document.getElementById('task-tracker');
        const stepDisplay        = document.getElementById('step-count');
        const gridContainer      = document.getElementById('grid-container');
        const taskPrompt         = document.getElementById('task-prompt');
        const feedback           = document.getElementById('feedback');
        const confirmBtn         = document.getElementById('confirm-btn');
        const timerBarWrapper    = document.getElementById('timer-bar-wrapper');
        const timerBar           = document.getElementById('timer-bar');
        const timerLabel         = document.getElementById('timer-label');

        // ===== HELPERS =====

        function typeToClass(type) {
            switch (type) {
                case 'healthy':          return '';
                case 'busy':             return 'status-busy';
                case 'critical':         return 'status-critical';
                case 'healthy-latency':  return 'status-healthy-latency';
                case 'busy-latency':     return 'status-latency';
                case 'critical-latency': return 'status-critical-latency';
                default: return '';
            }
        }

        function randomIndex(exclude) {
            let idx;
            do { idx = Math.floor(Math.random() * 25); }
            while (exclude.includes(idx));
            return idx;
        }

        // ===== TIMER =====

        function startTimer() {
            timerStart = Date.now();
            timerBar.style.width = '100%';
            timerBar.className = '';
            timerBarWrapper.style.display = 'block';
            timerLabel.style.display = 'block';

            timerInterval = setInterval(() => {
                const elapsed = (Date.now() - timerStart) / 1000;
                const remaining = Math.max(0, TIMER_DURATION - elapsed);
                const pct = (remaining / TIMER_DURATION) * 100;

                timerBar.style.width = pct + '%';
                timerLabel.textContent = Math.ceil(remaining) + 's';

                if (remaining <= 5) {
                    timerBar.className = 'danger';
                } else if (remaining <= 10) {
                    timerBar.className = 'warning';
                } else {
                    timerBar.className = '';
                }

                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    handleTimeout();
                }
            }, 250);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function hideTimer() {
            timerBarWrapper.style.display = 'none';
            timerLabel.style.display = 'none';
        }

        function getElapsedTime() {
            return ((Date.now() - timerStart) / 1000).toFixed(1);
        }

        function handleTimeout() {
            taskLocked = true;
            feedback.textContent = "\u23F1 Time\u2019s up! Skipping to next task\u2026";
            feedback.className = 'wrong';
            confirmBtn.disabled = true;

            results.push({
                time: null,
                attempts: currentAttempts,
                status: 'timeout'
            });

            setTimeout(() => { advanceTask(); }, 1200);
        }

        // ===== CORE =====

        function startTest() {
            instructionsScreen.style.display = 'none';
            dashboardScreen.style.display = 'block';
            taskTracker.style.display = 'block';
            results = [];
            currentTask = 0;
            loadTask();
        }

        function loadTask() {
            const task = TASKS[currentTask];
            stepDisplay.innerText = currentTask + 1;
            taskPrompt.innerHTML = task.prompt;
            feedback.textContent = '';
            feedback.className = '';
            confirmBtn.disabled = true;
            selectedIndex = -1;
            currentAttempts = 0;
            taskLocked = false;
            buildGrid(task);
            startTimer();
        }

        function buildGrid(task) {
            gridContainer.innerHTML = '';
            const usedIndices = [];
            const isTrick = task.target === 'any';

            if (!isTrick) {
                targetIndex = randomIndex(usedIndices);
                usedIndices.push(targetIndex);

                const distractorPositions = [];
                for (const d of task.distractors) {
                    const di = randomIndex(usedIndices);
                    usedIndices.push(di);
                    distractorPositions.push({ index: di, type: d });
                }

                for (let i = 0; i < 25; i++) {
                    const node = document.createElement('div');
                    node.className = 'server-node';
                    const indicator = document.createElement('div');
                    indicator.className = 'indicator';

                    if (i === targetIndex) {
                        const cls = typeToClass(task.target);
                        if (cls) node.classList.add(cls);
                    } else {
                        const dp = distractorPositions.find(d => d.index === i);
                        if (dp) {
                            const cls = typeToClass(dp.type);
                            if (cls) node.classList.add(cls);
                        }
                    }

                    node.appendChild(indicator);
                    const idx = i;
                    node.addEventListener('click', () => selectNode(idx));
                    gridContainer.appendChild(node);
                }
            } else {
                // TRICK: all healthy, any click is correct
                targetIndex = -1;
                for (let i = 0; i < 25; i++) {
                    const node = document.createElement('div');
                    node.className = 'server-node';
                    const indicator = document.createElement('div');
                    indicator.className = 'indicator';
                    node.appendChild(indicator);
                    const idx = i;
                    node.addEventListener('click', () => selectNode(idx));
                    gridContainer.appendChild(node);
                }
            }
        }

        function selectNode(idx) {
            if (taskLocked) return;
            const nodes = gridContainer.querySelectorAll('.server-node');
            nodes.forEach(n => n.classList.remove('selected'));
            nodes[idx].classList.add('selected');
            selectedIndex = idx;
            confirmBtn.disabled = false;
            feedback.textContent = '';
            feedback.className = '';
        }

        function confirmSelection() {
            if (selectedIndex === -1 || taskLocked) return;

            const task = TASKS[currentTask];
            const isTrick = task.target === 'any';
            const isCorrect = isTrick || selectedIndex === targetIndex;

            currentAttempts++;

            if (isCorrect) {
                taskLocked = true;
                stopTimer();
                const elapsed = getElapsedTime();

                feedback.textContent = '\u2713 Correct!';
                feedback.className = 'correct';
                confirmBtn.disabled = true;

                results.push({
                    time: parseFloat(elapsed),
                    attempts: currentAttempts,
                    status: 'pass'
                });

                setTimeout(() => { advanceTask(); }, 800);
            } else {
                feedback.textContent = '\u2717 Wrong server. Please try again.';
                feedback.className = 'wrong';

                const nodes = gridContainer.querySelectorAll('.server-node');
                nodes[selectedIndex].classList.remove('selected');
                selectedIndex = -1;
                confirmBtn.disabled = true;
            }
        }

        function advanceTask() {
            currentTask++;
            if (currentTask >= TASKS.length) {
                stopTimer();
                hideTimer();
                dashboardScreen.style.display = 'none';
                taskTracker.style.display = 'none';
                buildReport();
                completeScreen.style.display = 'block';
            } else {
                loadTask();
            }
        }

        // ===== REPORT =====

        function buildReport() {
            const tbody = document.getElementById('report-body');
            tbody.innerHTML = '';

            let totalPass = 0, totalTimeout = 0, totalWrongAttempts = 0;

            results.forEach((r, i) => {
                const tr = document.createElement('tr');

                const tdNum = document.createElement('td');
                tdNum.textContent = i + 1;
                tr.appendChild(tdNum);

                const tdDesc = document.createElement('td');
                tdDesc.textContent = TASK_LABELS[i] || '';
                tr.appendChild(tdDesc);

                const tdTime = document.createElement('td');
                if (r.status === 'timeout') {
                    tdTime.textContent = '> 15s';
                    tdTime.style.color = '#FFC107';
                } else {
                    tdTime.textContent = r.time + 's';
                }
                tr.appendChild(tdTime);

                const tdAttempts = document.createElement('td');
                tdAttempts.textContent = r.attempts;
                tr.appendChild(tdAttempts);

                const tdStatus = document.createElement('td');
                if (r.status === 'pass') {
                    tdStatus.textContent = 'Passed';
                    tdStatus.className = 'report-status-pass';
                    totalPass++;
                } else if (r.status === 'timeout') {
                    tdStatus.textContent = 'Failed (Timed Out)';
                    tdStatus.className = 'report-status-timeout';
                    totalTimeout++;
                }

                totalWrongAttempts += Math.max(0, r.attempts - (r.status === 'pass' ? 1 : 0));

                tr.appendChild(tdStatus);
                tbody.appendChild(tr);
            });

            document.getElementById('report-correct').textContent = totalPass;
            document.getElementById('report-wrong').textContent = totalWrongAttempts;
            document.getElementById('report-timeout').textContent = totalTimeout;

            // Total time: sum of passed task times + 15s for each timeout
            let totalTime = 0;
            results.forEach(r => {
                totalTime += r.status === 'timeout' ? TIMER_DURATION : r.time;
            });
            document.getElementById('report-total-time').textContent = totalTime.toFixed(1) + 's';
        }
    </script>
</body>
</html>
